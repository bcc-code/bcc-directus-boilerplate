# Directus app boilerplate

A boilerplate for using Directus with best practices inside BCC.

## Setup locally (using docker)

1. Clone the repo
2. (optional) Create a 1Password Vault or get access to one that contains the secrets you need to run this app locally.
3. Adjust `local.env` file if needed. You can get inspiration from `.env.example`. Add secrets in form of 1Password references.
4. Install dependencies by `npm install`
5. Need to prepare `shared` to be used by Directus `cd shared && npm install && npm run build`
6. Start database with `docker compose up -d`
7. When you run application for the first time, run `npm run init`.
8. Run `npm run local` to run locally

Initial admin user is: `admin@example.com | 12345678`.

## Documentation

### Auto swagger documentation for custom endpoints

The swagger documentation generated by `directus` does not contain custom endpoints. In the project, we use the `tsoa` library to generate swagger documentation for our public api.

#### Usage

To generate `docs/swagger.json` run `tsoa spec`.

#### Convention

- Create `exampleService.ts` which extends `ItemsService`
- Create `exampleController.ts` with injected `exampleService.ts`. Controller should contains tsoa annotations
- Create `index.ts` file to register custom directus endpoints. There you can add endpoint, create controller instance and execute the desired method.

#### Important

There is a problem with `@Query` annotation when query is an object. In that case just use `@Inject`, but your query will not be in the documentation.


### Seeding data to database

The command `npm run init` will import test data prefixed with `testdata__` from `schema-sync/data` folder.

Look at configuration file in `schema-sync/local_config.js`.

It syncs `directus_users` table, but only the admin user. This is needed in order to get a Directus instance with an admin user available.
It syncs `todo_lists` and `todo_items` test tables. These can be removed and replaced with whatever tables are needed.

Documentation for schema-sync extension can be found here <https://github.com/bcc-code/directus-schema-sync>

### Testing the Docker container locally

Run `docker build -t test-directus -f Dockerfile.prod .` to build the test image.

Copy  `.env.example` to `dockertest.env` and change `DB_HOST` to `host.docker.internal`.

Run `docker run -v "%cd%/dockertest.env:/home/node/app/.env" --name directustest -dp 127.0.0.1:8055:8055 test-directus` to run the image.

To cleanup run `docker stop directustest && docker rm directustest && docker image rm test-directus`
